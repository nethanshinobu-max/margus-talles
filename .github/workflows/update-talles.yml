name: Update Talles Data

on:
  schedule:
    - cron:  '0 3 * * *'  # Todos los dÃ­as a las 3 AM
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  update-talles:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node. js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install axios cheerio
      
      - name: Scrape talles from Margus
        run: |
          cat > scrape-talles.js << 'EOF'
          const axios = require('axios');
          const cheerio = require('cheerio');
          const fs = require('fs');

          const marcas = [
            'cenitho', 'isostasia1', 'torine', 'inquieta', 'gorsi', 'striven',
            'deka', 'crisal', 'flex', 'sttevia', 'sonne', 'versus',
            'ana-clara', 'andar', 'volsano', 'cruzo', 'h-reina', 'rumaju',
            'principessa', 'kawaii', 'yekus', 'thalasso', 'exito',
            'topazzio', 'ohmydenim', 'gooco'
          ];

          async function scrapeMarca(marca) {
            try {
              const url = `https://margusoficial.com/marcas/${marca}/`;
              const response = await axios.get(url, { timeout: 10000 });
              const $ = cheerio.load(response.data);
              
              const talles = [];
              $('[data-filter-name="Talles"]').each((i, elem) => {
                const talle = $(elem).attr('data-filter-value');
                const talleNum = parseInt(talle);
                if (!isNaN(talleNum) && talleNum >= 34 && talleNum <= 64) {
                  talles.push(talleNum);
                }
              });
              
              return talles.sort((a, b) => a - b);
            } catch (error) {
              console.error(`Error scraping ${marca}:`, error.message);
              return [];
            }
          }

          async function updateAllMarcas() {
            const tallesData = {};
            
            for (const marca of marcas) {
              console. log(`Scraping ${marca}...`);
              const talles = await scrapeMarca(marca);
              if (talles. length > 0) {
                tallesData[marca] = talles;
                console.log(`${marca}: ${talles.join(', ')}`);
              }
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            fs.writeFileSync('talles-data.json', JSON.stringify(tallesData, null, 2));
            console.log('âœ… talles-data.json actualizado!');
          }

          updateAllMarcas();
          EOF
          node scrape-talles.js
      
      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add talles-data.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update talles data from Margus" && git push)
